import streamlit as st
import pandas as pd
import requests

# 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQh2Zc7U-GRR9SRp0ElOMhsfdJmgKAPBGsHwTicoVTrutHdZCLSA5hwuQymluTlvNM5OLd5wY_95LCe/pub?gid=0&single=true&output=csv"

st.set_page_config(page_title="TAS POS PROFESSIONAL", layout="wide")

# 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô KeyError)
@st.cache_data(ttl=60)
def load_stock_data():
    try:
        df = pd.read_csv(SHEET_URL)
        df.columns = df.columns.str.strip() # ‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error
        if 'Name' not in df.columns: df['Name'] = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
        if 'Price' not in df.columns: df['Price'] = 0
        if 'Stock' not in df.columns: df['Stock'] = 0
        if 'Image_URL' not in df.columns: df['Image_URL'] = ""
        
        # ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
        df['Price'] = pd.to_numeric(df['Price'], errors='coerce').fillna(0)
        df['Stock'] = pd.to_numeric(df['Stock'], errors='coerce').fillna(0).astype(int)
        
        return df
    except Exception as e:
        st.error(f"‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}")
        return pd.DataFrame()

# 3. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏£‡∏∞‡∏ö‡∏ö
if 'pos_cart' not in st.session_state: st.session_state.pos_cart = {}
if 'pos_history' not in st.session_state: st.session_state.pos_history = []
if 'last_bill' not in st.session_state: st.session_state.last_bill = None

# ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏°‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
df_stock = load_stock_data()

# 4. ‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á
st.sidebar.title("üì¶ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£")
menu = st.sidebar.radio("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π", ["üõí ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢ (POS)", "üìä ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ & ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô"])

if st.sidebar.button("üîÑ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î"):
    st.cache_data.clear()
    st.rerun()

# ==========================================
# ‡∏´‡∏ô‡πâ‡∏≤ 1: POS
# ==========================================
if menu == "üõí ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢ (POS)":
    st.title("üè™ TAS POS SYSTEM")
    col_products, col_cart = st.columns([3.3, 1.7])

    with col_products:
        if not df_stock.empty:
            grid = st.columns(4)
            for i, row in df_stock.iterrows():
                with grid[i % 4]:
                    # ‡πÉ‡∏ä‡πâ .get() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô KeyError ‡∏ã‡πâ‡∏≠‡∏ô
                    stock_val = row.get('Stock', 0)
                    price_val = row.get('Price', 0)
                    name_val = row.get('Name', "Unknown")
                    img_url = row.get('Image_URL', "")
                    
                    stock_color = "red" if stock_val <= 5 else "#888"
                    
                    st.markdown(f"""
                        <div style="background-color:#1a1c24; border-radius:12px; border:1px solid #333; padding:10px; text-align:center; height:300px; margin-bottom:10px;">
                            <div style="width:100%; height:120px; background:white; border-radius:8px; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                                <img src="{img_url}" style="max-width:90%; max-height:90%;">
                            </div>
                            <div style="font-weight:bold; margin-top:5px; color:white;">{name_val}</div>
                            <div style="color:#f1c40f; font-weight:bold;">{price_val:,.2f} ‡∏ø</div>
                            <div style="color:{stock_color}; font-size:0.9em;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: {stock_val}</div>
                        </div>
                    """, unsafe_allow_html=True)
                    
                    if stock_val > 0:
                        if st.button(f"‡πÄ‡∏•‡∏∑‡∏≠‡∏Å {name_val}", key=f"btn_{i}"):
                            if name_val in st.session_state.pos_cart:
                                st.session_state.pos_cart[name_val]['qty'] += 1
                            else:
                                st.session_state.pos_cart[name_val] = {'price': price_val, 'qty': 1}
                            st.rerun()
                    else:
                        st.button("‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î", key=f"btn_{i}", disabled=True)

    with col_cart:
        st.subheader("üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤")
        if st.session_state.pos_cart:
            total = 0
            for name, data in list(st.session_state.pos_cart.items()):
                total += data['price'] * data['qty']
                st.write(f"**{name}** x{data['qty']}")
            
            st.divider()
            st.markdown(f"## ‡∏£‡∏ß‡∏°: :orange[{total:,.2f}] ‡∏ø")
            
            pay_type = st.radio("‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞:", ["‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î", "‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"], horizontal=True)
            if st.button("‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢", type="primary", use_container_width=True):
                st.session_state.pos_history.append({"‡πÄ‡∏ß‡∏•‡∏≤": pd.Timestamp.now().strftime("%H:%M"), "‡∏¢‡∏≠‡∏î": total, "‡∏ß‡∏¥‡∏ò‡∏µ": pay_type})
                st.session_state.last_bill = {"total": total, "method": pay_type}
                st.session_state.pos_cart = {}
                st.rerun()
        
        elif st.session_state.last_bill:
            bill = st.session_state.last_bill
            st.success(f"‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à {bill['total']:,} ‡∏ø")
            if bill['method'] == "‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô":
                st.image(f"https://promptpay.io/0945016189/{bill['total']}.png")
            if st.button("‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà"):
                st.session_state.last_bill = None
                st.rerun()

# ==========================================
# ‡∏´‡∏ô‡πâ‡∏≤ 2: ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ & ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
# ==========================================
else:
    st.title("üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ï‡πá‡∏≠‡∏Å")
    if not df_stock.empty:
        st.dataframe(
            df_stock[['Name', 'Price', 'Stock']],
            column_config={
                "Name": "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤",
                "Price": st.column_config.NumberColumn("‡∏£‡∏≤‡∏Ñ‡∏≤", format="%.2f"),
                "Stock": "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠"
            },
            use_container_width=True, hide_index=True
        )
    else:
        st.warning("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πá‡∏≠‡∏Å")
