import streamlit as st
import pandas as pd
import time

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
st.set_page_config(page_title="TAS POS SYSTEM", layout="wide")

# 1. ‡∏£‡∏ß‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏≤‡∏Å Google Sheets ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö CSV ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
STOCK_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQh2Zc7U-GRR9SRp0ElOMhsfdJmgKAPBGsHwTicoVTrutHdZCLSA5hwuQymluTlvNM5OLd5wY_95LCe/pub?gid=228640428&single=true&output=csv"
SALES_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQh2Zc7U-GRR9SRp0ElOMhsfdJmgKAPBGsHwTicoVTrutHdZCLSA5hwuQymluTlvNM5OLd5wY_95LCe/pub?gid=952949333&single=true&output=csv"

# 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πá‡∏≠‡∏Å
@st.cache_data(ttl=5)
def load_stock():
    try:
        # ‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ time ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤ (Cache)
        df = pd.read_csv(f"{STOCK_URL}&t={int(time.time())}")
        df.columns = df.columns.str.strip() # ‡∏ï‡∏±‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        df['Price'] = pd.to_numeric(df['Price'], errors='coerce').fillna(0)
        df['Stock'] = pd.to_numeric(df['Stock'], errors='coerce').fillna(0).astype(int)
        return df
    except Exception as e:
        st.error(f"‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: {e}")
        return pd.DataFrame()

# 3. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
if 'cart' not in st.session_state: st.session_state.cart = {}
if 'last_total' not in st.session_state: st.session_state.last_total = 0

df_stock = load_stock()

# 4. ‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á
st.sidebar.title("üè™ TAS POS")
menu = st.sidebar.radio("‡πÄ‡∏°‡∏ô‡∏π", ["üõí ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å"])

if st.sidebar.button("üîÑ ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà"):
    st.cache_data.clear()
    st.rerun()

# --- ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ---
if menu == "üõí ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤":
    st.title("üè™ TAS POS SYSTEM")
    
    if not df_stock.empty:
        col_list, col_cart = st.columns([3, 2])
        
        with col_list:
            st.subheader("üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤")
            grid = st.columns(3)
            for i, row in df_stock.iterrows():
                with grid[i % 3]:
                    st.markdown(f"""
                        <div style="background:#1a1c24; border:1px solid #444; padding:10px; border-radius:10px; text-align:center; margin-bottom:10px;">
                            <img src="{row['Image_URL']}" style="height:100px; width:100px; object-fit:contain; background:white; border-radius:8px;">
                            <div style="font-weight:bold; color:white; margin-top:10px;">{row['Name']}</div>
                            <div style="color:#f1c40f; font-size:1.2em; font-weight:bold;">{row['Price']:,} ‡∏ø</div>
                            <div style="color:{'#2ecc71' if row['Stock'] > 0 else '#e74c3c'};">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: {row['Stock']}</div>
                        </div>
                    """, unsafe_allow_html=True)
                    
                    if row['Stock'] > 0:
                        if st.button(f"‡πÄ‡∏•‡∏∑‡∏≠‡∏Å {row['Name']}", key=f"pos_{i}", use_container_width=True):
                            name = row['Name']
                            if name in st.session_state.cart:
                                st.session_state.cart[name]['qty'] += 1
                            else:
                                st.session_state.cart[name] = {'price': row['Price'], 'qty': 1}
                            st.rerun()
                    else:
                        st.button("‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î", key=f"pos_{i}", disabled=True, use_container_width=True)

        with col_cart:
            st.subheader("üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤")
            if st.session_state.cart:
                total = 0
                for name, item in list(st.session_state.cart.items()):
                    sub = item['price'] * item['qty']
                    total += sub
                    c1, c2 = st.columns([4, 1])
                    c1.write(f"**{name}** x {item['qty']} ({sub:,} ‡∏ø)")
                    if c2.button("‚ùå", key=f"del_{name}"):
                        del st.session_state.cart[name]
                        st.rerun()
                st.divider()
                st.markdown(f"## ‡∏£‡∏ß‡∏°: :orange[{total:,}] ‡∏ø")
                if st.button("‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô", type="primary", use_container_width=True):
                    st.session_state.last_total = total
                    st.session_state.cart = {}
                    st.rerun()
            elif st.session_state.last_total > 0:
                st.success(f"‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô: {st.session_state.last_total:,} ‡∏ø")
                if st.button("‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•‡πÉ‡∏´‡∏°‡πà"):
                    st.session_state.last_total = 0
                    st.rerun()
            else:
                st.info("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤")
    else:
        st.warning("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets...")

# --- ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å ---
else:
    st.title("üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤")
    if not df_stock.empty:
        st.dataframe(df_stock[['Name', 'Price', 'Stock']], use_container_width=True, hide_index=True)
        st.info(f"‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠: {time.strftime('%H:%M:%S')}")
