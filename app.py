import streamlit as st
import pandas as pd
import requests
import time
from io import StringIO
from datetime import datetime, timedelta

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
URL_STOCK = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQh2Zc7U-GRR9SRp0ElOMhsfdJmgKAPBGsHwTicoVTrutHdZCLSA5hwuQymluTlvNM5OLd5wY_95LCe/pub?gid=228640428&single=true&output=csv"
URL_SALES = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQh2Zc7U-GRR9SRp0ElOMhsfdJmgKAPBGsHwTicoVTrutHdZCLSA5hwuQymluTlvNM5OLd5wY_95LCe/pub?gid=952949333&single=true&output=csv"
URL_PRODUCTS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQh2Zc7U-GRR9SRp0ElOMhsfdJmgKAPBGsHwTicoVTrutHdZCLSA5hwuQymluTlvNM5OLd5wY_95LCe/pub?gid=1258507712&single=true&output=csv"

SCRIPT_URL = "https://script.google.com/macros/s/AKfycbySel8Dxd6abzj7-JbYtaAgH3saKHBkeGsl47fpfUe293MmVwZM_Bx2K4CthYKUI4Ks/exec"
MY_PROMPTPAY = "0945016189" 

st.set_page_config(page_title="TAS POS Ultra Fast V.7", layout="wide")

# --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏á: ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏°‡∏µ Cache ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ) ---
@st.cache_data(ttl=60)
def load_data_cached(url):
    try:
        response = requests.get(f"{url}&t={time.time()}", timeout=3)
        response.encoding = 'utf-8'
        df = pd.read_csv(StringIO(response.text))
        df.columns = df.columns.str.strip()
        return df.dropna(how='all').reset_index(drop=True)
    except:
        return pd.DataFrame()

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö Real-time (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ Cache ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥)
def load_stock_realtime():
    try:
        response = requests.get(f"{URL_STOCK}&t={time.time()}", timeout=3)
        df = pd.read_csv(StringIO(response.text))
        return df.dropna(how='all').reset_index(drop=True)
    except:
        return pd.DataFrame()

# ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Session State
if 'cart' not in st.session_state: st.session_state.cart = {}
if 'receipt' not in st.session_state: st.session_state.receipt = None

menu = st.sidebar.radio("üè¨ ‡πÄ‡∏°‡∏ô‡∏π‡∏£‡∏∞‡∏ö‡∏ö", ["üõí ‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢", "üì¶ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å"])

if menu == "üõí ‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤":
    # ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÉ‡∏ä‡πâ Cache ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß)
    df_p = load_data_cached(URL_PRODUCTS)
    # ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å (Real-time ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å)
    if 'df_s' not in st.session_state:
        st.session_state.df_s = load_stock_realtime()
    
    col_main, col_right = st.columns([2.3, 1.7])
    
    with col_main:
        st.subheader("üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤")
        if not df_p.empty:
            grid = st.columns(3)
            for i, row in df_p.iterrows():
                p_name = str(row.iloc[0])
                p_price = float(row.iloc[1])
                p_img = row.iloc[3] if len(row) > 3 else ""
                
                # ‡∏î‡∏∂‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Session ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏•‡∏¥‡∏Å (‡∏•‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏á)
                s_match = st.session_state.df_s[st.session_state.df_s.iloc[:, 0] == p_name] if not st.session_state.df_s.empty else pd.DataFrame()
                stock_now = int(s_match.iloc[0, 1]) if not s_match.empty else 0
                qty_in_cart = st.session_state.cart.get(p_name, {}).get('qty', 0)
                
                with grid[i % 3]:
                    with st.container(border=True):
                        st.image(p_img if p_img else "https://via.placeholder.com/150", use_container_width=True)
                        st.markdown(f"**{p_name}**")
                        color = "red" if stock_now <= 5 else "#00ff00"
                        st.markdown(f"‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span style='color:{color}; font-weight:bold;'>{stock_now}</span>", unsafe_allow_html=True)
                        
                        # ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡πÑ‡∏ß)
                        if stock_now > qty_in_cart:
                            if st.button(f"‚ûï {p_price:,.0f} ‡∏ø", key=f"add_{i}", use_container_width=True):
                                st.session_state.cart[p_name] = st.session_state.cart.get(p_name, {'price': p_price, 'qty': 0})
                                st.session_state.cart[p_name]['qty'] += 1
                                st.rerun() # ‡∏£‡∏µ‡∏£‡∏±‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞ UI ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡πá‡∏ï‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        else:
                            st.button("‚ùå ‡∏´‡∏°‡∏î", disabled=True, use_container_width=True, key=f"sold_{i}")

    with col_right:
        if st.session_state.receipt:
            r = st.session_state.receipt
            st.success("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")
            qr_html = f'<div style="text-align:center;"><img src="https://promptpay.io/{MY_PROMPTPAY}/{r["total"]}.png" style="width:180px;"></div>' if r['method'] == "üì± PromptPay" else ""
            
            st.markdown(f"""
            <div style="background:#fff; color:#000; padding:15px; border:2px solid #333; font-family:monospace; border-radius:5px;">
                <h3 style="text-align:center; margin:0;">RECEIPT</h3>
                <hr>
                {''.join([f'<div style="display:flex;justify-content:space-between;"><span>{n} x{i["qty"]}</span><span>{i["price"]*i["qty"]:,.0f}</span></div>' for n,i in r['items'].items()])}
                <hr>
                <div style="display:flex;justify-content:space-between;font-size:18px;font-weight:bold;"><span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span><span>{r['total']:,.0f} ‡∏ø</span></div>
                {qr_html}
            </div>
            """, unsafe_allow_html=True)
            
            # ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á: ‡∏•‡πâ‡∏≤‡∏á Cache ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤)
            if st.button("üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà (Reset)", type="primary", use_container_width=True):
                if 'df_s' in st.session_state: del st.session_state.df_s
                st.session_state.receipt = None
                st.rerun()
        else:
            st.subheader("üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤")
            total = sum(i['price'] * i['qty'] for i in st.session_state.cart.values())
            for n, i in list(st.session_state.cart.items()):
                c1, c2 = st.columns([3, 1])
                c1.write(f"**{n}** x{i['qty']}")
                if c2.button("üóëÔ∏è", key=f"del_{n}"):
                    del st.session_state.cart[n]; st.rerun()
            
            if total > 0:
                st.divider()
                method = st.radio("‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞", ["üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î", "üì± PromptPay"], horizontal=True)
                if st.button("üöÄ ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô", type="primary", use_container_width=True):
                    bill_id = f"B{int(time.time())}"
                    summary = ", ".join([f"{k}({v['qty']})" for k,v in st.session_state.cart.items()])
                    # ‡∏¢‡∏¥‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏ß‡πâ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ response ‡∏ô‡∏≤‡∏ô (Fire and Forget)
                    try: requests.post(SCRIPT_URL, json={"action":"checkout","bill_id":bill_id,"summary":summary,"total":total,"method":method}, timeout=0.1)
                    except: pass
                    st.session_state.receipt = {"items": dict(st.session_state.cart), "total": total, "method": method}
                    st.session_state.cart = {}
                    st.rerun()

elif menu == "üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢":
    st.title("üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô")
    # ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏î‡πÄ‡∏™‡∏°‡∏≠
    df_sales = load_data_cached.clear() # ‡∏•‡πâ‡∏≤‡∏á cache ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏¢‡∏≠‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    df_sales = load_data_cached(URL_SALES)
    
    if not df_sales.empty:
        col_dt = df_sales.columns[0]
        col_total = df_sales.columns[3]
        df_sales[col_dt] = pd.to_datetime(df_sales[col_dt], dayfirst=True, errors='coerce')
        now = datetime.now()
        
        m1, m2, m3 = st.columns(3)
        df_today = df_sales[df_sales[col_dt].dt.date == now.date()]
        m1.metric("‡∏¢‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ", f"{df_today[col_total].sum():,.0f} ‡∏ø")
        m2.metric("‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå", f"{df_sales[df_sales[col_dt] >= (now - timedelta(days=7))][col_total].sum():,.0f} ‡∏ø")
        m3.metric("‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", f"{df_sales[df_sales[col_dt].dt.month == now.month][col_total].sum():,.0f} ‡∏ø")
        
        # ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡πÉ‡∏™‡πà try-except ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error ‡∏™‡∏µ‡πÅ‡∏î‡∏á)
        if st.button("üìù ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏µ‡∏ï Summary"):
            try:
                res = requests.post(SCRIPT_URL, json={
                    "action": "save_summary",
                    "date": now.strftime("%d/%m/%Y"),
                    "total": float(df_today[col_total].sum()),
                    "bills": int(len(df_today))
                }, timeout=5)
                st.success("‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
            except:
                st.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß")

        st.dataframe(df_sales.iloc[::-1], use_container_width=True)

elif menu == "üì¶ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å":
    st.dataframe(load_stock_realtime(), use_container_width=True)
