import streamlit as st
import pandas as pd
import requests
from io import StringIO

# 1. ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏´‡∏°‡πà (Force CSV)
# ‡∏ú‡∏°‡πÉ‡∏ä‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏±‡∏ö‡∏™‡∏ô
STOCK_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQh2Zc7U-GRR9SRp0ElOMhsfdJmgKAPBGsHwTicoVTrutHdZCLSA5hwuQymluTlvNM5OLd5wY_95LCe/pub?gid=228640428&single=true&output=csv"

st.set_page_config(page_title="TAS POS SYSTEM", layout="wide")

# 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà (‡∏Ç‡πâ‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏ö Cache ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
def get_fresh_data():
    try:
        # ‡πÉ‡∏ä‡πâ requests ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå
        response = requests.get(STOCK_CSV_URL)
        response.encoding = 'utf-8'
        data = StringIO(response.text)
        new_df = pd.read_csv(data)
        
        # ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
        new_df.columns = new_df.columns.str.strip()
        new_df['Price'] = pd.to_numeric(new_df['Price'], errors='coerce').fillna(0)
        new_df['Stock'] = pd.to_numeric(new_df['Stock'], errors='coerce').fillna(0).astype(int)
        return new_df
    except Exception as e:
        st.error(f"Error: {e}")
        return pd.DataFrame()

# 3. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
df_pos = get_fresh_data()

# 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
st.title("üè™ TAS POS SYSTEM")

# ‡∏ñ‡πâ‡∏≤‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
if not df_pos.empty:
    st.success("‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏°
    if len(df_pos) > 0:
        c1, c2 = st.columns([3, 2])
        
        with c1:
            st.subheader("üì¶ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢")
            grid = st.columns(3)
            for i, row in df_pos.iterrows():
                with grid[i % 3]:
                    st.markdown(f"""
                        <div style="background:#262730; border:1px solid #444; padding:15px; border-radius:10px; text-align:center;">
                            <img src="{row['Image_URL']}" style="height:100px; width:100px; object-fit:contain; background:white; border-radius:8px;">
                            <h4 style="margin:10px 0;">{row['Name']}</h4>
                            <h3 style="color:#f1c40f;">{row['Price']:,} ‡∏ø</h3>
                            <p style="color:#2ecc71;">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: {row['Stock']}</p>
                        </div>
                    """, unsafe_allow_html=True)
                    if row['Stock'] > 0:
                        st.button(f"‡πÄ‡∏•‡∏∑‡∏≠‡∏Å {row['Name']}", key=f"id_{i}")
                    else:
                        st.button("‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î", key=f"id_{i}", disabled=True)
        
        with c2:
            st.subheader("üõí ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
            st.info("‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°...")
            
    else:
        st.warning("‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï Stock (‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 2 ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ)")
else:
    st.error("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Reboot ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Manage App")

# ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏î‡πà‡∏ß‡∏ô
if st.sidebar.button("üîÑ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà"):
    st.rerun()
