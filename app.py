import streamlit as st
import pandas as pd
import requests
import segno
import io

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå (‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á Library ‡πÄ‡∏û‡∏¥‡πà‡∏°)
def generate_promptpay_code(phone, amount):
    target = phone.replace("-", "").[:10]
    target = "00066" + target if len(target) == 10 else target
    amount_str = f"{amount:.2f}".replace(".", "")
    amount_len = f"{len(f'{amount:.2f}'):02d}"
    
    # ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á PromptPay
    payload = f"00020101021129370016A000000677010111011300{len(target):02d}{target}5802TH54{amount_len}{amount:.2f}5303764"
    
    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì CRC16 (‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡πÅ‡∏Å‡∏ô‡∏ï‡∏¥‡∏î)
    # ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ Library ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô Error ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå API ‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö
    return f"https://promptpay.io/{phone}/{amount}.png"

# 1. ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢
API_URL = "https://script.google.com/macros/s/AKfycbxwm0SVcvcm327H-zdEIa7RCM6I5HwWst9UtXqRU_gvoiBXeZkVrxczLUDIFHVvrw_z/exec"

# 2. ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQh2Zc7U-GRR9SRp0ElOMhsfdJmgKAPBGsHwTicoVTrutHdZCLSA5hwuQymluTlvNM5OLd5wY_95LCe/pub?gid=0&single=true&output=csv"

st.set_page_config(page_title="POS TAS System", layout="wide")

@st.cache_data(ttl=5)
def load_products():
    try:
        df = pd.read_csv(SHEET_URL)
        df.columns = df.columns.str.strip()
        return df
    except: return pd.DataFrame()

df_products = load_products()
if 'cart' not in st.session_state: st.session_state.cart = []

st.title("üè™ ‡∏£‡∏∞‡∏ö‡∏ö POS TAS (‡∏à‡πà‡∏≤‡∏¢‡∏ú‡πà‡∏≤‡∏ô 094-501-6189)")

col1, col2 = st.columns([2, 1])

with col1:
    st.subheader("üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤")
    if not df_products.empty:
        cols = st.columns(4)
        for i, row in df_products.iterrows():
            with cols[i % 4]:
                name, price = row['Name'], row['Price']
                img = row.get('Image_URL', 'https://via.placeholder.com/150')
                st.image(img, use_container_width=True)
                if st.button(f"{name}\n{price}.-", key=f"btn_{i}"):
                    st.session_state.cart.append({"Name": name, "Price": price})
                    st.rerun()

with col2:
    st.subheader("üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤")
    if st.session_state.cart:
        df_cart = pd.DataFrame(st.session_state.cart)
        st.table(df_cart)
        total = df_cart['Price'].sum()
        st.write(f"## ‡∏£‡∏ß‡∏°: {total:,.2f} ‡∏ö‡∏≤‡∏ó")
        
        if st.button("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô"):
            # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢
            data = {"bill_id": "BILL-"+pd.Timestamp.now().strftime("%H%M%S"), "items": ", ".join(df_cart['Name'].tolist()), "total": float(total)}
            try:
                res = requests.post(API_URL, json=data)
                if res.status_code == 200:
                    st.success("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!")
                    # ‡πÅ‡∏™‡∏î‡∏á QR Code ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå‡∏à‡∏≤‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå 0945016189
                    qr_url = f"https://promptpay.io/0945016189/{total}.png"
                    st.image(qr_url, caption=f"‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ö‡∏≠‡∏£‡πå 094-501-6189 ‡∏¢‡∏≠‡∏î {total} ‡∏ö‡∏≤‡∏ó")
                    st.session_state.cart = []
                else: st.error("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
            except: st.error("‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤")
            
        if st.button("‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤"):
            st.session_state.cart = []
            st.rerun()
