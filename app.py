import streamlit as st
import pandas as pd
import requests
import plotly.express as px # ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü

# 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
API_URL = "https://script.google.com/macros/s/AKfycbxwm0SVcvcm327H-zdEIa7RCM6I5HwWst9UtXqRU_gvoiBXeZkVrxczLUDIFHVvrw_z/exec"
# *‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á ‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'Stock' ‡πÉ‡∏ô Google Sheets ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQh2Zc7U-GRR9SRp0ElOMhsfdJmgKAPBGsHwTicoVTrutHdZCLSA5hwuQymluTlvNM5OLd5wY_95LCe/pub?gid=0&single=true&output=csv"

st.set_page_config(page_title="TAS PROFESSIONAL POS & ADMIN", layout="wide")

# 2. CSS ‡πÄ‡∏î‡∏¥‡∏° + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå Dashboard
st.markdown("""
    <style>
    .main { background-color: #0e1117; }
    .product-card {
        background-color: #1a1c24; border-radius: 12px; border: 1px solid #333;
        padding: 10px; margin-bottom: 5px; display: flex; flex-direction: column;
        align-items: center; height: 260px; justify-content: space-between;
    }
    .img-box {
        width: 100%; height: 140px; background-color: white; border-radius: 8px;
        display: flex; align-items: center; justify-content: center;
        overflow: hidden;
    }
    .img-box img { max-width: 90%; max-height: 90%; object-fit: contain; }
    .p-name { color: white !important; font-weight: bold; text-align: center; font-size: 0.9em; }
    .p-price { color: #f1c40f !important; font-weight: bold; font-size: 1.1em; }
    .stButton > button { width: 100% !important; border-radius: 8px !important; font-weight: bold !important; }
    /* Dashboard Style */
    .metric-box {
        background-color: #1a1c24; padding: 20px; border-radius: 10px; 
        border-left: 5px solid #28a745; margin-bottom: 10px;
    }
    p, span, label, h1, h2, h3, div { color: white !important; }
    </style>
    """, unsafe_allow_html=True)

# 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Session
@st.cache_data(ttl=60)
def get_products():
    try:
        df = pd.read_csv(SHEET_URL)
        df.columns = df.columns.str.strip()
        # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Stock ‡πÉ‡∏´‡πâ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤ (‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô Google Sheets ‡∏Ñ‡∏£‡∏±‡∏ö)
        if 'Stock' not in df.columns:
            df['Stock'] = 50 
        return df
    except: return pd.DataFrame()

if 'cart' not in st.session_state: st.session_state.cart = {}
if 'sales_history' not in st.session_state: st.session_state.sales_history = []

# --- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å ---
menu = st.sidebar.radio("‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å", ["üõí ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (POS)", "üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ & ‡∏™‡∏ï‡πá‡∏≠‡∏Å"], index=0)

# ==========================================
# üõí ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (POS)
# ==========================================
if menu == "üõí ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (POS)":
    df_products = get_products()
    st.title("üè™ TAS PROFESSIONAL POS")
    
    col_main, col_cart = st.columns([3.8, 1.2])

    with col_main:
        if not df_products.empty:
            rows = [df_products[i:i + 4] for i in range(0, df_products.shape[0], 4)]
            for row_data in rows:
                cols = st.columns(4)
                for idx, (i, row) in enumerate(row_data.iterrows()):
                    with cols[idx]:
                        st.markdown(f"""
                            <div class="product-card">
                                <div class="img-box"><img src="{row['Image_URL']}"></div>
                                <div class="p-name">{row['Name']}</div>
                                <div class="p-price">{row['Price']:,} ‡∏ø</div>
                                <div style='color: #aaa; font-size: 0.8em;'>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: {row['Stock']}</div>
                            </div>
                        """, unsafe_allow_html=True)
                        if st.button(f"‚ûï ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å", key=f"add_{i}"):
                            name, price = row['Name'], row['Price']
                            if name in st.session_state.cart:
                                st.session_state.cart[name]['qty'] += 1
                            else:
                                st.session_state.cart[name] = {'price': price, 'qty': 1}
                            st.rerun()
        else: st.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ")

    with col_cart:
        st.subheader("üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤")
        if st.session_state.cart:
            total = 0
            items_summary = []
            for name, info in list(st.session_state.cart.items()):
                subtotal = info['price'] * info['qty']
                total += subtotal
                items_summary.append(f"{name} x{info['qty']}")
                
                c1, c2 = st.columns([3, 1])
                with c1:
                    st.write(f"**{name}**")
                    st.caption(f"{info['qty']} x {info['price']:,} ‡∏ø")
                with c2:
                    if st.button("‚ùå", key=f"del_{name}"):
                        st.session_state.cart[name]['qty'] -= 1
                        if st.session_state.cart[name]['qty'] <= 0: del st.session_state.cart[name]
                        st.rerun()
            
            st.divider()
            st.markdown(f"### ‡∏£‡∏ß‡∏°: :orange[{total:,.2f}] ‡∏ø")
            pay_type = st.radio("‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞:", ["‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î", "‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"], horizontal=True)
            
            if st.button("‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢", type="primary", use_container_width=True):
                bill_id = "B" + pd.Timestamp.now().strftime("%H%M%S")
                # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏à‡∏≥‡∏•‡∏≠‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)
                st.session_state.sales_history.append({
                    "Time": pd.Timestamp.now().strftime("%H:%M"),
                    "Items": ", ".join(items_summary),
                    "Total": total,
                    "Type": pay_type
                })
                
                # ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheets
                data_url = f"{API_URL}?bill_id={bill_id}&items={', '.join(items_summary)}&total={total}&payment_type={pay_type}"
                try: requests.get(data_url, timeout=0.1)
                except: pass
                
                st.session_state.last_bill = {"total": total, "type": pay_type}
                st.session_state.cart = {}
                st.rerun()
        else:
            if 'last_bill' in st.session_state and st.session_state.last_bill:
                st.success(f"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î {st.session_state.last_bill['total']:,} ‡∏ø ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
                if st.button("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏¥‡∏•‡πÉ‡∏´‡∏°‡πà"):
                    st.session_state.last_bill = None
                    st.rerun()
            else: st.write("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...")

# ==========================================
# üìä ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ & ‡∏™‡∏ï‡πá‡∏≠‡∏Å
# ==========================================
else:
    st.title("üìä ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô (Dashboard & Stock)")
    
    # --- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ ---
    st.subheader("üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ")
    if st.session_state.sales_history:
        df_sales = pd.DataFrame(st.session_state.sales_history)
        
        m1, m2, m3 = st.columns(3)
        with m1:
            st.markdown(f"<div class='metric-box'><h3>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</h3><h2>{df_sales['Total'].sum():,.2f} ‡∏ø</h2></div>", unsafe_allow_html=True)
        with m2:
            st.markdown(f"<div class='metric-box'><h3>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•</h3><h2>{len(df_sales)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2></div>", unsafe_allow_html=True)
        with m3:
            cash = df_sales[df_sales['Type'] == '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î']['Total'].sum()
            transfer = df_sales[df_sales['Type'] == '‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô']['Total'].sum()
            st.markdown(f"<div class='metric-box'><h3>‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</h3><p>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î: {cash:,} | ‡πÇ‡∏≠‡∏ô: {transfer:,}</p></div>", unsafe_allow_html=True)

        # ‡∏Å‡∏£‡∏≤‡∏ü‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
        fig = px.line(df_sales, x="Time", y="Total", title="‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÜ", markers=True)
        st.plotly_chart(fig, use_container_width=True)
        
        # ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        with st.expander("üìù ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ö‡∏¥‡∏•"):
            st.table(df_sales)
    else:
        st.info("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡πà‡∏ô‡∏ô‡∏µ‡πâ")

    st.divider()

    # --- ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å ---
    st.subheader("üì¶ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤")
    df_stock = get_products()
    if not df_stock.empty:
        # ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥ (‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 10 ‡∏ä‡∏¥‡πâ‡∏ô)
        def highlight_low_stock(val):
            color = '#ff4b4b' if val < 10 else 'none'
            return f'background-color: {color}'

        st.dataframe(df_stock[['Name', 'Price', 'Stock']].style.applymap(highlight_low_stock, subset=['Stock']), use_container_width=True)
        
        st.caption("‚ö†Ô∏è ‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î (Stock < 10)")
    else:
        st.error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πá‡∏≠‡∏Å")

    if st.button("üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Sheets"):
        st.cache_data.clear()
        st.rerun()
